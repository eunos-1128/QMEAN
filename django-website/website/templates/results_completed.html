{% extends 'results_base.html' %}{% load static %}
{% block css %}<link rel="stylesheet" href="{% static 'css/fancybox/jquery.fancybox.css?v=2.1.5' %}" type="text/css" media="screen" />{% endblock %}
{% block extra_title %}
<a style="font-size:16px" target="_blank" href="{% url 'archive' projectid=projectid %}">Project Archive <i class="glyphicon glyphicon-download-alt"></i></a>
{% endblock %}
{% block results_block %}
<div class="row" style="margin-top:16px;">
<div class="col-sm-7">

{% for model in input_data.models %}
<div style="border: 1px solid #ddd; border-radius: 10px;padding:16px;margin-bottom:8px;">
	<table class="table table-condensed notop">
		<tr><th width="160">QMEAN Value:</th><td>{{ model.global_scores.qmean4.zscore|floatformat:"2" }}
			<div class="pull-right"><label>Display 3D <input modelid="{{ model.modelid }}" autocomplete="off" type="checkbox" {% if forloop.first %}checked="checked"{% endif %}></label></div>
		</td></tr>
	</table>
	<table class="table table-condensed notop">
		<tr><th  width="160">Model Files:</th>
		<td><a target="_blank" href="{% url 'model_structure' projectid=projectid modelid=model.modelid %}">processed_{{ model.name }} <i class="glyphicon glyphicon-file" style="margin-right:8px;"></i></a>
		<a target="_blank" href="{% url 'archive' projectid=projectid modelid=model.modelid %}">Model Results Archive <i class="glyphicon glyphicon-download-alt"></i></a>
		</td></tr>		
	</table>
	<table class="table table-condensed notop">
		<tr>
			<td style="vertical-align:middle">
				<a class="fancybox thumbnail" rel="{{ model.modelid }}" href="{% url 'qmean_pix' projectid=projectid modelid=model.modelid name='qmean4.png' %}"><img title="Z-scores" class="qmean" src="{% url 'qmean_pix' projectid=projectid modelid=model.modelid name='qmean4.png' %}"></a>
			</td>
			<td>
				<a class="fancybox thumbnail" rel="{{ model.modelid }}" href="{% url 'qmean_pix' projectid=projectid modelid=model.modelid name='local_quality_estimate.png' %}"><img title="Absolute Quality" class="qmean" src="{% url 'qmean_pix' projectid=projectid modelid=model.modelid name='local_quality_estimate.png' %}"></a>
				<div style="display:none">{% for plot in model.local_quality_plots %}
					<a class="fancybox" rel="{{ model.modelid }}" href="{% url 'qmean_pix' projectid=projectid modelid=model.modelid name=plot %}"><img title="Absolute Quality" class="qmean" src="{% url 'qmean_pix' projectid=projectid modelid=model.modelid name=plot %}"></a>{% endfor %}
				</div>
			</td>
			<td><a class="fancybox thumbnail" rel="{{ model.modelid }}" href="{% url 'qmean_pix' projectid=projectid modelid=model.modelid name='reference_set.png' %}">
				<img title="Reference Comparison" class="qmean" src="{% url 'qmean_pix' projectid=projectid modelid=model.modelid name='reference_set.png' %}"></a>
			</td>
		</tr>
	</table>

</div>
{% endfor %}
</div>

<div class="col-sm-5">
	<div id="viewerWrapper" style="border: 1px solid #DDD; border-radius: 10px; padding:7px; margin-bottom:4px; height:300px;  width:100%">
	    <div id="pv" style="width:100%;height:100%;position:relative;">
	     	<div id="pv_status"></div>
	 	</div>
	</div>
	<div style="float:right" >
        <label style="margin-left:4px;padding: 5px 2px 5px 2px;" class="label label-primary">&nbsp;<a target="_blank" href="http://biasmv.github.io/pv/" style="color:#FFF">pv<i style="opacity:0.8; ont-size:.6em; margin-left:2px" class="glyphicon glyphicon-new-window"></i></a>&nbsp;</label>
   	</div>
</div>

<div class="clearfix">&nbsp;</div>
{% endblock %}
{% block js %}{{ block.super }}
<script type="text/javascript" src="{% static 'js/jquery.mousewheel-3.0.6.pack.js' %}"></script>
<script type="text/javascript" src="{% static 'js/jquery.fancybox.pack.js' %}"></script>
<script type='text/javascript' src="{% static 'js/bio-pv.min.js' %}"></script>
<script>
var pv_viewer = pv.Viewer(document.getElementById('pv'), {
          width: 300,
          height: 300,
          antialias: true,
          quality : 'high'
        });

$(document).ready(
	function()
	{	
		$(".fancybox").fancybox();
		$('#viewerWrapper').height( $('#viewerWrapper').width() );
      	$('#pv').height( $('#viewerWrapper').width() );
      	$(window).resize(function() {
          $('#viewerWrapper').height( $('#viewerWrapper').width() );
          $('#pv').height( $('#viewerWrapper').width() );
          pv_viewer.fitParent();
        });
	
		$('input[modelid]').on('click',function(){
			showModel($(this).attr('modelid'),$(this).prop('checked'));
		});

		loadModel('{{ input_data.models.0.modelid }}');
	});

function showModel(modelid, show)
{
	if(!show)
		pv_viewer.hide(modelid+'*');
	else
	{
		var loaded = false;
		pv_viewer.forEach(
			function(v)
			{
				if(v.name().indexOf(modelid)==0)
				{
					v.show();
					loaded = true;
				}
			});
		if(!loaded)
		{
			console.info('load it')
			loadModel(modelid);
		}
	}
	pv_viewer.autoZoom();
	pv_viewer.requestRedraw();
}
function loadModel(modelid)
{
	$.get('{% url 'model_structure' projectid=projectid modelid='model_000' %}'.replace('model_000',modelid),
	        function(data,s)
	        {
	            var pv_structure = pv.io.pdb(data);
	            var tube = pv_viewer.tube(modelid, pv_structure.select('protein') );
	            tube.colorBy( pv.color.byAtomProp('tempFactor',
	                        pv.color.gradient(['#F33','#33F'])
	                        ,[.3,1]
	                        ) );
	            pv_viewer.ballsAndSticks(modelid+'.ligands',pv_structure.select({'chain':'_'}));
	            var dna = pv_structure.select('ligand').select({'rnames':['A','C','T','G','U','DA','DC','DG','DT']});
	            if(dna.residueCount()>0)
	              pv_viewer.lines(modelid+'.dna',dna);

	            pv_viewer.fitParent();
	            pv_viewer.autoZoom();
	        });
}
</script>
{% endblock %}
